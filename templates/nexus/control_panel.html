{% extends "nexus/nexus_base.html" %}

{% block scripts %}
    <script type="text/JavaScript">
        function choose_item(key) {
            var tree = $('#tree').dynatree("getTree");
            var node = tree.getNodeByKey(key);

            if( node != null ) {
                node.activate();
            }

            return false;
        }

        $(document).ready(function(){
            // hide node and metapage action divs
            $('#folder_actions').hide();
            $('#metapage_actions').hide();

            // perform action when user does something with site select
            $('#site_select').change(function() {
                var value = $(this).attr('value');
                if( value == 'nop' ) {
                    console.debug('id10t selected separator')
                    return;
                }
                if( value == 'add' ) {
                    console.debug('id10t selected add')
                    return;
                }

                // if you get here then user selected a site, load the tree
                $("#tree").dynatree({
                    onActivate: function(node) {
                        // hide the context toolbars
                        $('#folder_actions').hide();
                        $('#metapage_actions').hide();

                        // load contents of node
                        var pieces = node.data.key.split(":");
                        var node_type = pieces[0];
                        var node_id = pieces[1];

                        var link = '/yacon/nexus/metapage_info/';
                        if( node_type == 'node' )
                            link = '/yacon/nexus/node_info/';

                        link += "" + node_id + "/";

                        $("div#node_container").load(link);

                        // show the appropriate action bar
                        if( node_type == 'node') {
                            $('#folder_actions').show();
                        }
                        if( node_type == 'metapage') {
                            // action is a metapage
                            $('#metapage_actions').show();
                        }
                    },
                    onPostInit: function(isReloading, isError) {
                        // activate event doesn't trigger on a reload, our
                        // dynamic content is loaded via activate, so force
                        // the activation after initialization
                        this.reactivate();
                    },
                    persist: true,
                    initAjax: {
                        url: "/yacon/nexus/full_tree/" + value + "/"
                    }
                });
            });

            // load list of sites
            $.ajax({
                url: "/yacon/nexus/get_sites/",
                dataType: "json",
                success: function(data) {
                    // remove old sites, replace with what server sent
                    $('#site_select').children().remove();
                    for( var key in data ){
                        if( data.hasOwnProperty(key) ){
                            $('#site_select').append('<option value="' +
                                key + '">' + data[key] + '</option>');
                        }
                    }

                    // add site actions
                    $('#site_select').append('<option value="nop">' + 
                        '----------</option>');
                    $('#site_select').append('<option value="add">Add Site' +
                        '</option>');

                    // trigger change based on selection
                    $('#site_select').change();
                }
            });

            // ---------------------------------------------------------
            // Dialog Boxes

            // Add Child Folder
            $('#add_folder_dialog').dialog({
                autoOpen: false,
                modal: true,
                buttons: {
                    "Ok":function() {
                        console.debug('do add child stuff here');
                        $(this).dialog('close');
                        return false;
                    },
                    "Cancel":function() {
                        $(this).dialog('close');
                        return false;
                    }
                },
                title: 'Add Child Folder'
            });

        });
    </script>
{% endblock scripts %}

{% block content %}
<div class="left">
    <form>
        <label>Site:</label>&nbsp;
        <select id="site_select">
        </select>
    </form>
    <br/>
    <div id="tree">
    </div>
</div>
<div class="right">
    <div id="folder_actions">
        <a href="#" onclick="$('#add_folder_dialog').dialog('open')" >
            Add Child Folder</a>&nbsp;
        <a href="#" >Add Child Page</a>&nbsp;
        <a href="#" >Remove Folder</a>&nbsp;
    </div>
    <div id="metapage_actions">
        <a href="#" >Remove Page</a>&nbsp;
    </div>
    <div id="node_container">
    </div>
</div>

<!-- Dialog Boxes -->
<div id="add_folder_dialog">
    <form id="add_folder_form">
        <label>Child Path</label>
        <input type="text" name="path"/>
    </form>
</div>

{% endblock content %}
